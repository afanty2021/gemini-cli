# 企业部署

<cite>
**本文档中引用的文件**   
- [enterprise.md](file://docs/cli/enterprise.md)
- [policy-engine.md](file://docs/core/policy-engine.md)
- [config.ts](file://packages/core/src/config/config.ts)
- [policy-engine.ts](file://packages/core/src/policy/policy-engine.ts)
- [config.ts](file://packages/core/src/policy/config.ts)
- [toml-loader.ts](file://packages/core/src/policy/toml-loader.ts)
- [storage.ts](file://packages/core/src/config/storage.ts)
- [oauth2.ts](file://packages/core/src/code_assist/oauth2.ts)
- [index.ts](file://packages/core/src/policy/index.ts)
- [deployment.md](file://docs/get-started/deployment.md)
</cite>

## 目录
1. [引言](#引言)
2. [集中配置管理](#集中配置管理)
3. [策略执行机制](#策略执行机制)
4. [审计日志功能](#审计日志功能)
5. [企业身份提供商集成](#企业身份提供商集成)
6. [部署架构示例](#部署架构示例)
7. [配置示例与迁移指南](#配置示例与迁移指南)

## 引言
本文档详细阐述了为大型组织设计的企业级功能，涵盖集中配置管理、策略执行、审计日志和身份集成等核心企业部署特性。通过系统级设置文件和策略引擎，管理员可以统一管理多个用户的设置，强制执行安全策略、使用限制和合规性规则。文档还探讨了与企业身份提供商（如OAuth）的集成方法，并提供了实际的部署架构示例和配置指南，以满足大型组织的合规性要求。

## 集中配置管理
企业部署的核心是通过系统级设置文件实现集中配置管理。管理员可以定义一个基线配置（`system-defaults.json`）和一组覆盖设置（`settings.json`），这些设置将应用于机器上的所有用户。配置的合并遵循特定的优先级顺序，确保企业策略具有最终决定权。

### 配置合并与优先级
配置从四个文件中合并，单值设置（如`theme`）的优先级顺序如下：
1.  系统默认值 (`system-defaults.json`)
2.  用户设置 (`~/.gemini/settings.json`)
3.  工作区设置 (`<project>/.gemini/settings.json`)
4.  系统覆盖 (`settings.json`)

系统覆盖文件具有最高优先级。对于数组（如`includeDirectories`）或对象（如`mcpServers`）类型的设置，其值会被合并。

**示例：**
- **系统默认值 `system-defaults.json`:**
  ```json
  {
    "ui": {
      "theme": "default-corporate-theme"
    },
    "context": {
      "includeDirectories": ["/etc/gemini-cli/common-context"]
    }
  }
  ```
- **用户 `settings.json`:**
  ```json
  {
    "ui": {
      "theme": "user-preferred-dark-theme"
    },
    "mcpServers": {
      "corp-server": {
        "command": "/usr/local/bin/corp-server-dev"
      }
    }
  }
  ```
- **工作区 `settings.json`:**
  ```json
  {
    "ui": {
      "theme": "project-specific-light-theme"
    },
    "mcpServers": {
      "project-tool": {
        "command": "npm start"
      }
    }
  }
  ```
- **系统覆盖 `settings.json`:**
  ```json
  {
    "ui": {
      "theme": "system-enforced-theme"
    },
    "mcpServers": {
      "corp-server": {
        "command": "/usr/local/bin/corp-server-prod"
      }
    }
  }
  ```

**最终合并配置：**
```json
{
  "ui": {
    "theme": "system-enforced-theme"
  },
  "mcpServers": {
    "corp-server": {
      "command": "/usr/local/bin/corp-server-prod"
    },
    "project-tool": {
      "command": "npm start"
    }
  },
  "context": {
    "includeDirectories": [
      "/etc/gemini-cli/common-context",
      "~/gemini-context",
      "./project-context",
      "/etc/gemini-cli/global-context"
    ]
  }
}
```

**系统设置文件位置：**
- **Linux**: `/etc/gemini-cli/settings.json`
- **Windows**: `C:\ProgramData\gemini-cli\settings.json`
- **macOS**: `/Library/Application Support/GeminiCli/settings.json`
- 路径可通过 `GEMINI_CLI_SYSTEM_SETTINGS_PATH` 环境变量覆盖。

**Section sources**
- [enterprise.md](file://docs/cli/enterprise.md#L17-L157)

### 通过包装脚本强制执行系统设置
为防止用户通过设置 `GEMINI_CLI_SYSTEM_SETTINGS_PATH` 环境变量来绕过企业配置，可以部署一个包装脚本或别名。该脚本会强制设置环境变量，并调用原始的 Gemini CLI 可执行文件，从而确保企业设置始终被加载。

**示例包装脚本：**
```bash
#!/bin/bash

# 强制指向企业系统设置文件的路径
export GEMINI_CLI_SYSTEM_SETTINGS_PATH="/etc/gemini-cli/settings.json"

# 查找原始的 gemini 可执行文件
REAL_GEMINI_PATH=$(type -aP gemini | grep -v "^$(type -P gemini)$" | head -n 1)

if [ -z "$REAL_GEMINI_PATH" ]; then
  echo "Error: The original 'gemini' executable was not found." >&2
  exit 1
fi

# 将所有参数传递给真正的 Gemini CLI 可执行文件
exec "$REAL_GEMINI_PATH" "$@"
```

**Section sources**
- [enterprise.md](file://docs/cli/enterprise.md#L162-L204)

## 策略执行机制
策略引擎提供了一套强大的工具，用于精细控制工具的执行。它允许管理员和用户定义规则，以确定工具调用是被允许、拒绝还是需要用户确认。

### 核心概念
策略引擎基于一组规则运行。每条规则都包含条件、决策和优先级。当大语言模型想要执行一个工具时，策略引擎会评估所有规则，以找到与工具调用匹配的最高优先级规则。

**规则组件：**
- **条件 (Conditions)**: 工具调用必须满足的标准，例如工具名称或其参数。
- **决策 (Decision)**: 规则匹配时采取的行动（`allow`、`deny` 或 `ask_user`）。
- **优先级 (Priority)**: 决定规则优先级的数字，数值越高优先级越高。

### 优先级系统与层级
策略引擎使用一个复杂的优先级系统来解决冲突。规则被组织成三个层级，每个层级都有一个基础值，用于计算最终优先级。

| 层级 (Tier) | 基础值 (Base) | 描述 |
| :--- | :--- | :--- |
| 默认 (Default) | 1 | 随 Gemini CLI 发布的内置策略。 |
| 用户 (User) | 2 | 用户定义的自定义策略。 |
| 管理员 (Admin) | 3 | 管理员管理的策略（例如，在企业环境中）。 |

最终优先级的计算公式为：`final_priority = tier_base + (toml_priority / 1000)`。这确保了管理员策略始终覆盖用户和默认策略。

**Section sources**
- [policy-engine.md](file://docs/core/policy-engine.md#L11-L98)

### 策略规则匹配
当进行工具调用时，引擎会从最高优先级开始检查所有活动规则。第一个匹配的规则将决定结果。

**匹配条件：**
1.  **工具名称**: 规则中的 `toolName` 必须与被调用的工具名称匹配。对于 MCP 服务器，可以使用通配符 `my-server__*` 来匹配该服务器上的任何工具。
2.  **参数模式**: 如果指定了 `argsPattern`，工具的参数将被转换为稳定的 JSON 字符串，并与提供的正则表达式进行测试。

**示例规则：**
```toml
[[rule]]
toolName = "run_shell_command"
commandPrefix = "git "
decision = "ask_user"
priority = 100
```
此规则会在执行任何 `git` 命令前要求用户确认。

**Section sources**
- [policy-engine.md](file://docs/core/policy-engine.md#L107-L124)
- [policy-engine.ts](file://packages/core/src/policy/policy-engine.ts#L23-L65)

### 企业级策略配置
管理员可以通过在系统级 `settings.json` 文件中定义策略来强制执行企业策略。这些策略可以基于工具名称、命令前缀或正则表达式来控制访问。

**示例：限制工具访问**
```json
{
  "tools": {
    "core": ["ReadFileTool", "GlobTool", "ShellTool(ls)"]
  }
}
```
此配置仅允许安全的、只读的文件操作和列出文件。

**示例：禁用 YOLO 模式**
```json
{
  "security": {
    "disableYoloMode": true
  }
}
```
此设置强制所有工具执行都需要用户确认，防止意外操作。

**Section sources**
- [enterprise.md](file://docs/cli/enterprise.md#L206-L267)
- [config.ts](file://packages/core/src/config/config.ts#L239-L241)

## 审计日志功能
为了满足合规性要求，Gemini CLI 提供了审计日志功能，允许管理员配置将遥测数据发送到中央位置，以跟踪工具使用情况和其他事件。

### 遥测配置
管理员可以启用遥测并将数据发送到本地 OTLP 收集器或 Google Cloud Platform (GCP)。

**示例：启用遥测**
```json
{
  "telemetry": {
    "enabled": true,
    "target": "gcp",
    "logPrompts": false
  }
}
```
**注意**：在企业环境中，应将 `logPrompts` 设置为 `false`，以避免收集用户提示中的潜在敏感信息。

**Section sources**
- [enterprise.md](file://docs/cli/enterprise.md#L438-L459)
- [index.ts](file://packages/core/src/telemetry/index.ts#L7-L10)

## 企业身份提供商集成
Gemini CLI 支持与企业身份提供商（如 Google Workspace）的集成，以强制执行特定的认证方法和域限制。

### 强制认证方法
管理员可以通过在系统级 `settings.json` 文件中设置 `enforcedAuthType` 来强制所有用户使用特定的认证方法。

**示例：强制使用 Google 登录**
```json
{
  "enforcedAuthType": "oauth-personal"
}
```

### 限制登录到企业域
对于使用 Google Workspace 的企业，可以通过网络代理服务器配置来强制用户只能使用其企业 Google 账户进行身份验证。这通过在拦截到 Google 的请求时添加一个特殊的 HTTP 头 `X-GoogApps-Allowed-Domains` 来实现。

**示例头信息：**
```
X-GoogApps-Allowed-Domains: my-corporate-domain.com, secondary-domain.com
```
当存在此头信息时，Google 的身份验证服务将只允许来自指定域的账户登录。

**Section sources**
- [enterprise.md](file://docs/cli/enterprise.md#L461-L512)
- [oauth2.ts](file://packages/core/src/code_assist/oauth2.ts#L68-L85)

## 部署架构示例
Gemini CLI 的部署架构支持多种安装和执行方法，以适应不同的企业需求。

### 部署选项
1.  **标准安装**: 通过 NPM 全局安装，适用于大多数标准用户。
    ```bash
    npm install -g @google/gemini-cli
    ```
2.  **沙箱中运行**: 在 Docker 或 Podman 容器中运行，以提高安全性和隔离性。
    ```bash
    gemini --sandbox -y -p "your prompt here"
    ```
3.  **从源代码运行**: 对于项目贡献者，可以直接从源代码运行。

**架构组件：**
- **NPM 包**: 项目发布两个核心包：`@google/gemini-cli-core`（后端）和 `@google/gemini-cli`（前端）。
- **构建和打包**: 使用 TypeScript 编译器 (`tsc`) 构建 NPM 包，或使用 `esbuild` 从 GitHub 直接捆绑。
- **Docker 沙箱镜像**: `gemini-cli-sandbox` 容器镜像支持基于 Docker 的执行。

**Section sources**
- [deployment.md](file://docs/get-started/deployment.md#L3-L144)

## 配置示例与迁移指南
本节提供了一个综合的系统 `settings.json` 配置示例，展示了如何将多种模式结合起来，为 Gemini CLI 创建一个安全、受控的环境。

### 综合系统配置示例
```json
{
  "tools": {
    "sandbox": "docker",
    "core": [
      "ReadFileTool",
      "GlobTool",
      "ShellTool(ls)",
      "ShellTool(cat)",
      "ShellTool(grep)"
    ]
  },
  "mcp": {
    "allowed": ["corp-tools"]
  },
  "mcpServers": {
    "corp-tools": {
      "command": "/opt/gemini-tools/start.sh",
      "timeout": 5000
    }
  },
  "telemetry": {
    "enabled": true,
    "target": "gcp",
    "otlpEndpoint": "https://telemetry-prod.example.com:4317",
    "logPrompts": false
  },
  "advanced": {
    "bugCommand": {
      "urlTemplate": "https://servicedesk.example.com/new-ticket?title={title}&details={info}"
    }
  },
  "privacy": {
    "usageStatisticsEnabled": false
  }
}
```

**此配置实现了：**
- 强制所有工具执行都在 Docker 沙箱中进行。
- 严格使用允许列表，仅允许一组安全的 shell 命令和文件工具。
- 定义并允许一个单一的企业 MCP 服务器用于自定义工具。
- 启用用于审计的遥测，但不记录提示内容。
- 将 `/bug` 命令重定向到内部工单系统。
- 禁用常规使用情况统计收集。

**迁移指南：**
1.  **规划**: 评估当前的用户配置和工作流程。
2.  **创建策略**: 根据安全需求定义系统级 `settings.json` 和策略文件。
3.  **测试**: 在小范围内部署并测试配置。
4.  **部署**: 通过包装脚本或系统管理工具将配置推送到所有目标机器。
5.  **监控**: 利用审计日志监控工具使用情况和合规性。

**Section sources**
- [enterprise.md](file://docs/cli/enterprise.md#L513-L565)