# 开发者指南

<cite>
**本文档中引用的文件**  
- [README.md](file://README.md)
- [CONTRIBUTING.md](file://CONTRIBUTING.md)
- [package.json](file://package.json)
- [local-development.md](file://docs/local-development.md)
- [architecture.md](file://docs/architecture.md)
- [build.js](file://scripts/build.js)
- [start.js](file://scripts/start.js)
- [cli/package.json](file://packages/cli/package.json)
- [core/package.json](file://packages/core/package.json)
- [a2a-server/package.json](file://packages/a2a-server/package.json)
- [test-utils/package.json](file://packages/test-utils/package.json)
- [vscode-ide-companion/package.json](file://packages/vscode-ide-companion/package.json)
</cite>

## 目录
1. [简介](#简介)
2. [本地开发环境搭建](#本地开发环境搭建)
3. [项目结构与模块化设计](#项目结构与模块化设计)
4. [测试策略](#测试策略)
5. [代码贡献流程](#代码贡献流程)
6. [调试指南](#调试指南)
7. [API文档与设计原则](#api文档与设计原则)

## 简介

本指南旨在为希望为Gemini CLI项目做出贡献的开发者提供全面的技术文档。Gemini CLI是一个开源的AI代理工具，可将Gemini的强大功能直接带入终端环境。本指南将详细介绍如何搭建本地开发环境、理解项目架构、编写测试、贡献代码以及调试问题。通过遵循本指南，开发者可以快速上手并有效参与到项目的开发和改进中。

## 本地开发环境搭建

### 依赖安装

在开始开发之前，需要确保系统中已安装以下依赖：

- **Node.js**: 开发环境推荐使用Node.js `~20.19.0`版本，生产环境要求Node.js `>=20`。可以使用[nvm](https://github.com/nvm-sh/nvm)等工具管理Node.js版本。
- **Git**: 用于代码版本控制。

### 构建流程

1. **克隆仓库**:
   ```bash
   git clone https://github.com/google-gemini/gemini-cli.git
   cd gemini-cli
   ```

2. **安装依赖**:
   ```bash
   npm install
   ```

3. **构建项目**:
   ```bash
   npm run build
   ```
   此命令会编译TypeScript代码，打包资源，并准备项目以供执行。

4. **构建所有组件**（包括沙箱）:
   ```bash
   npm run build:all
   ```

### 运行测试套件

项目包含单元测试和集成测试，确保代码质量。

- **运行单元测试**:
  ```bash
  npm run test
  ```

- **运行集成测试**:
  ```bash
  npm run test:e2e
  ```

- **运行预检检查**（包含格式化、linting、测试等）:
  ```bash
  npm run preflight
  ```

**Section sources**
- [CONTRIBUTING.md](file://CONTRIBUTING.md#L174-L258)
- [package.json](file://package.json#L41-L48)

## 项目结构与模块化设计

### 核心包结构

项目采用模块化设计，主要分为以下几个核心包：

- **`packages/cli`**: 命令行界面，负责用户输入处理、输出展示和用户体验管理。
- **`packages/core`**: 核心后端逻辑，处理与Gemini API的通信、提示词构建、工具执行等。
- **`packages/a2a-server`**: A2A服务器实现（实验性）。
- **`packages/test-utils`**: 测试工具，用于创建和清理临时文件系统。
- **`packages/vscode-ide-companion`**: VS Code扩展，与Gemini CLI配合使用。

### 代码结构导航

- **CLI包** (`packages/cli/src`): 包含命令、配置、服务、UI组件等。
- **核心包** (`packages/core/src`): 包含代理、可用性、代码辅助、配置、钩子、工具等模块。
- **文档** (`docs/`): 包含详细的使用文档和开发指南。

开发者可以通过这些目录快速定位到特定功能的代码实现。

**Section sources**
- [CONTRIBUTING.md](file://CONTRIBUTING.md#L318-L330)
- [architecture.md](file://docs/architecture.md#L5-L39)

## 测试策略

### 单元测试

单元测试位于各个包的`__tests__`或`test`目录中，使用Vitest框架进行测试。

- **运行单元测试**:
  ```bash
  npm run test
  ```

### 集成测试

集成测试位于`integration-tests/`目录，验证Gemini CLI的端到端功能。

- **运行集成测试**:
  ```bash
  npm run test:e2e
  ```

### 测试编写方法

- **单元测试**: 针对单个函数或类进行测试，确保其行为符合预期。
- **集成测试**: 模拟用户交互，测试整个工作流程的正确性。

**Section sources**
- [CONTRIBUTING.md](file://CONTRIBUTING.md#L230-L257)
- [package.json](file://package.json#L42-L48)

## 代码贡献流程

### 贡献步骤

1. **Fork仓库**并创建新分支。
2. **进行修改**，在`packages/`目录下进行代码更改。
3. **确保所有检查通过**，运行`npm run preflight`。
4. **提交Pull Request**，链接到相关issue。

### Pull Request指南

- **链接到现有issue**: 所有PR都应关联到一个已存在的issue。
- **保持小而专注**: PR应专注于解决单一问题或添加单一功能。
- **使用草稿PR**: 对于正在进行的工作，使用GitHub的草稿PR功能。
- **更新文档**: 如果PR引入了用户可见的更改，必须更新相关文档。
- **清晰的提交信息**: 遵循[Conventional Commits](https://www.conventionalcommits.org/)标准。

**Section sources**
- [CONTRIBUTING.md](file://CONTRIBUTING.md#L39-L143)

## 调试指南

### VS Code调试

1. **启动调试模式**:
   ```bash
   npm run debug
   ```

2. **在VS Code中使用"Attach"配置**连接到调试器。

### React DevTools

用于调试CLI的React UI。

1. **启动开发模式**:
   ```bash
   DEV=true npm start
   ```

2. **安装并运行React DevTools**:
   ```bash
   npm install -g react-devtools@4.28.5
   react-devtools
   ```

### 开发追踪

启用开发追踪以调试代码。

1. **启动追踪服务器**:
   ```bash
   npm run telemetry -- --target=genkit
   ```

2. **运行Gemini CLI**:
   ```bash
   GEMINI_DEV_TRACING=true gemini
   ```

**Section sources**
- [CONTRIBUTING.md](file://CONTRIBUTING.md#L333-L393)
- [local-development.md](file://docs/local-development.md#L6-L85)

## API文档与设计原则

### 核心API

- **CLI包**: 提供用户界面和输入处理。
- **Core包**: 提供与Gemini API通信、提示词管理、工具执行等核心功能。

### 设计原则

- **模块化**: 将CLI（前端）与Core（后端）分离，便于独立开发和扩展。
- **可扩展性**: 工具系统设计为可扩展，允许添加新功能。
- **用户体验**: CLI专注于提供丰富和交互式的终端体验。

**Section sources**
- [architecture.md](file://docs/architecture.md#L72-L81)